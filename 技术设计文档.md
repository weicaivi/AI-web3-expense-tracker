# 技术设计文档：AI Web3记账 Hackathon Demo

## 1. 项目概览

### 1.1 Demo目标
在1-2周内完成一个可演示的原型，展示**AI智能记账 + Web3数据主权**的核心概念。

### 1.2 核心演示点
- ✅ AI自然语言记账："今天吃饭30块" → 自动解析
- ✅ OCR图片识别
- ✅ 数据加密存储到IPFS（去中心化）
- ✅ 钱包连接和数据恢复
- ✅ 一个NFT里程碑（展示Web3激励）

---

## 2. 最小系统架构

```
┌─────────────────────────────┐
│     前端 (Next.js)          │
│  • 输入框 + 列表展示        │
│  • 钱包连接按钮             │
│  • 简单的月度统计           │
└──────┬──────────────┬───────┘
       │              │
┌──────▼──────┐  ┌────▼─────┐
│  通义千问   │  │  IPFS    │
│  (NLP解析)  │  │ (存储)   │
└─────────────┘  └──────────┘
                      
       简单NFT合约(Sepolia)
       • 首次记账铸造NFT
```

---

## 3. 技术栈（极简版）

```typescript
{
  "前端": "Next.js 14 + TypeScript",
  "UI": "Tailwind CSS",  // 不用shadcn/ui，直接写样式更快
  "钱包": "RainbowKit",
  "AI": "通义千问 qwen-turbo",
  "存储": "Web3.Storage",
  "加密": "CryptoJS",
  "本地DB": "LocalStorage", // 不用IndexedDB，简化开发
  "合约": "Remix IDE直接部署" // 不用Hardhat，快速部署
}
```

---

## 4. 核心功能设计

### 4.1 AI文本解析（Demo重点）

**输入**：用户在输入框输入"今天吃饭30块"

**流程**：
```
用户输入 
→ 前端发送到 /api/parse 
→ 调用通义千问API 
→ 返回JSON: { amount: 30, category: "餐饮", date: "2025-11-17" }
→ 前端展示确认界面
→ 用户点击确认
→ 保存
```

**Prompt设计**（关键）：
```
你是记账助手。从用户输入提取：金额、分类、日期。

分类只能是: 餐饮、交通、购物、娱乐、其他

输入："今天吃饭30块"
输出JSON:
{
  "amount": 30,
  "category": "餐饮", 
  "date": "2025-11-17",
  "description": "吃饭"
}

不要返回其他内容，只返回JSON。
```

**容错**：如果AI返回格式错误，显示错误提示让用户重新输入。

---

### 4.2 数据存储（简化版）

**加密方案**：
```typescript
// 1. 用户连接钱包后，签名获取密钥
const signature = await signMessage("ExpenseTracker");
const key = SHA256(signature).toString();

// 2. 加密单条记账
const encrypted = AES.encrypt(JSON.stringify(expense), key);

// 3. 上传IPFS
const cid = await uploadToIPFS(encrypted);

// 4. 保存到LocalStorage
localStorage.setItem(`expense_${cid}`, JSON.stringify({
  cid,
  amount: expense.amount,  // 明文（用于展示）
  category: expense.category,
  date: expense.date
}));

// 5. 维护CID列表
const cidList = JSON.parse(localStorage.getItem('cidList') || '[]');
cidList.push(cid);
localStorage.setItem('cidList', JSON.stringify(cidList));
```

**为什么用LocalStorage而不是IndexedDB**：
- Demo只需要存储几十条数据
- LocalStorage实现更快
- 代码量少一半

**数据结构**：
```typescript
// LocalStorage存储格式
{
  "cidList": ["Qm123...", "Qm456..."],  // 所有CID
  "expense_Qm123": {                     // 每条记账的元数据
    "cid": "Qm123",
    "amount": 30,
    "category": "餐饮",
    "date": "2025-11-17"
  }
}
```

---

### 4.3 前端页面（单页应用）

**布局**：
```
┌─────────────────────────────────┐
│  Header: [连接钱包] [余额]      │
├─────────────────────────────────┤
│  输入区:                        │
│  ┌────────────────────┐  [提交] │
│  │ 今天吃饭30块       │         │
│  └────────────────────┘         │
│  AI解析中...                    │
├─────────────────────────────────┤
│  月度统计:                      │
│  总支出: ¥1,234                 │
│  餐饮: ¥456 | 交通: ¥234        │
├─────────────────────────────────┤
│  记录列表:                      │
│  [ ] 11-17  餐饮  ¥30  吃饭    │
│  [ ] 11-16  交通  ¥12  地铁    │
│  [ ] 11-15  购物  ¥89  ...     │
└─────────────────────────────────┘
```

**关键组件**：
1. **WalletConnect**：RainbowKit一行代码集成
2. **InputForm**：输入框 + 提交按钮
3. **ExpenseList**：简单的表格展示
4. **MonthStats**：饼图（用Chart.js快速实现）

---

### 4.4 NFT里程碑（展示Web3特性）

**极简设计**：只做一个里程碑 - "首次记账NFT"

**合约**（Solidity）：
```solidity
// 超简单版本
contract FirstExpenseNFT is ERC721 {
    uint256 public tokenCounter;
    mapping(address => bool) public hasMinted;
    
    constructor() ERC721("First Expense", "FE") {}
    
    function mintFirstExpense() external {
        require(!hasMinted[msg.sender], "Already minted");
        _safeMint(msg.sender, tokenCounter);
        hasMinted[msg.sender] = true;
        tokenCounter++;
    }
}
```

**前端集成**：
```typescript
// 用户第一次记账成功后
if (expenseCount === 1) {
  await contract.mintFirstExpense();
  alert("恭喜获得首次记账NFT！");
}
```

**部署**：
- 用Remix IDE直接部署到Sepolia
- 不需要元数据URI（Demo可省略）
- 前端只需要合约地址和ABI

---

## 5. 数据流

### 5.1 记账流程
```
1. 用户输入文本
2. 调用AI API解析 (1-2秒)
3. 显示解析结果供确认
4. 用户点确认
5. 加密数据 (瞬间)
6. 上传IPFS (3-5秒)
7. 保存CID到LocalStorage
8. 检查是否是第一笔 → 铸造NFT
9. 刷新列表显示
```

### 5.2 数据读取
```
1. 用户连接钱包
2. 从LocalStorage读取CID列表
3. 显示元数据（金额、分类、日期）
4. 【可选】点击查看详情时才从IPFS解密完整数据
```

---

## 6. API设计

### 6.1 AI解析API
```typescript
// /api/parse
POST /api/parse
Body: { text: "今天吃饭30块" }

Response: {
  success: true,
  data: {
    amount: 30,
    category: "餐饮",
    date: "2025-11-17",
    description: "吃饭"
  }
}
```

### 6.2 IPFS上传
```typescript
// /api/ipfs-upload
POST /api/ipfs-upload
Body: { data: "encrypted_string" }

Response: {
  cid: "QmXxx..."
}
```

---

## 7. 核心代码结构

```
/app
  /api
    /parse          # AI解析
    /ipfs-upload    # IPFS上传
  /components
    WalletConnect   # 钱包连接
    ExpenseForm     # 输入表单
    ExpenseList     # 记录列表
    MonthStats      # 月度统计
  /utils
    crypto.ts       # 加密工具
    ipfs.ts         # IPFS工具
  page.tsx          # 主页面

/contracts
  FirstExpenseNFT.sol  # NFT合约

/lib
  constants.ts      # 配置常量（合约地址、API Key）
```

---
